<?php
session_start();
if (!isset($_SESSION['id_utilisateur'])) {
    header("Location: ../auth/auth.php");
    exit();
}

include('../../config/db_conn.php');
include('../../includes/historique_helper.php');

$role = $_SESSION['role'];
$id_utilisateur = $_SESSION['id_utilisateur'];
$peut_modifier = in_array($role, ['admin', 'responsable_approvisionnement']);
$message = "";

// --- PAGINATION ---
$page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
$per_page = 15;
$offset = ($page - 1) * $per_page;

// --- RECHERCHE ---
$recherche = isset($_GET['recherche']) ? trim($_GET['recherche']) : '';

// --- AJOUT D'UN FOURNISSEUR ---
if ($peut_modifier && isset($_POST['ajouter'])) {
    $nom = trim($_POST['nom']);
    $telephone = trim($_POST['telephone']);
    $email = trim($_POST['email']);
    $adresse = trim($_POST['adresse']);

    if ($nom !== "") {
        $stmt = $conn->prepare("INSERT INTO fournisseurs (nom, telephone, email, adresse) VALUES (?, ?, ?, ?)");
        $stmt->bind_param("ssss", $nom, $telephone, $email, $adresse);
        if ($stmt->execute()) {
            $id_fournisseur = db_get_insert_id($conn);
            enregistrer_historique($conn, $id_utilisateur, 'ajout', 'fournisseurs', $id_fournisseur, "Ajout du fournisseur: $nom");
            $message = "âœ… Fournisseur ajoutÃ© avec succÃ¨s.";
        } else {
            $message = "âŒ Erreur lors de l'ajout : " . (isset($GLOBALS['is_postgresql']) && is_object($conn) && get_class($conn) === 'PostgreSQLConnection' ? $conn->error() : mysqli_error($conn));
        }
        $stmt->close();
    } else {
        $message = "âš ï¸ Le nom du fournisseur est obligatoire.";
    }
}

// --- MODIFICATION D'UN FOURNISSEUR ---
if ($peut_modifier && isset($_POST['modifier'])) {
    $id = intval($_POST['id']);
    $nom = trim($_POST['nom']);
    $telephone = trim($_POST['telephone']);
    $email = trim($_POST['email']);
    $adresse = trim($_POST['adresse']);
    
    $stmt = $conn->prepare("SELECT * FROM fournisseurs WHERE id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $result = $stmt->get_result();
    $ancien = (is_object($result) && method_exists($result, 'fetch_assoc') ? $result->fetch_assoc() : mysqli_fetch_assoc($result));
    $stmt->close();
    
    $stmt = $conn->prepare("UPDATE fournisseurs SET nom = ?, telephone = ?, email = ?, adresse = ? WHERE id = ?");
    $stmt->bind_param("ssssi", $nom, $telephone, $email, $adresse, $id);
    if ($stmt->execute()) {
        enregistrer_historique($conn, $id_utilisateur, 'modification', 'fournisseurs', $id, "Modification du fournisseur: $nom", $ancien, ['nom' => $nom, 'telephone' => $telephone, 'email' => $email]);
        $message = "âœ… Fournisseur modifiÃ© avec succÃ¨s.";
    } else {
        $message = "âŒ Erreur : " . (isset($GLOBALS['is_postgresql']) && is_object($conn) && get_class($conn) === 'PostgreSQLConnection' ? $conn->error() : mysqli_error($conn));
    }
    $stmt->close();
}

// --- SUPPRESSION D'UN FOURNISSEUR ---
if ($peut_modifier && isset($_GET['supprimer'])) {
    $id = intval($_GET['supprimer']);
    
    $stmt = $conn->prepare("SELECT * FROM fournisseurs WHERE id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $result = $stmt->get_result();
    $fournisseur = (is_object($result) && method_exists($result, 'fetch_assoc') ? $result->fetch_assoc() : mysqli_fetch_assoc($result));
    $stmt->close();
    
    $stmt = $conn->prepare("DELETE FROM fournisseurs WHERE id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $stmt->close();
    
    enregistrer_historique($conn, $id_utilisateur, 'suppression', 'fournisseurs', $id, "Suppression du fournisseur: " . $fournisseur['nom'], $fournisseur, null);
    header("Location: fournisseurs.php");
    exit();
}

// --- EXPORT CSV ---
if (isset($_GET['export']) && $_GET['export'] == 'csv') {
    header('Content-Type: text/csv; charset=utf-8');
    header('Content-Disposition: attachment; filename=fournisseurs_' . date('Y-m-d') . '.csv');
    
    $output = fopen('php://output', 'w');
    fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));
    
    fputcsv($output, ['ID', 'Nom', 'TÃ©lÃ©phone', 'Email', 'Adresse'], ';');
    
    $query = "SELECT * FROM fournisseurs ORDER BY nom ASC";
    $result = $conn->query($query);
    
    while ($row = (is_object($result) && method_exists($result, 'fetch_assoc') ? $result->fetch_assoc() : mysqli_fetch_assoc($result))) {
        fputcsv($output, [
            $row['id'],
            $row['nom'],
            $row['telephone'],
            $row['email'],
            $row['adresse']
        ], ';');
    }
    
    fclose($output);
    exit();
}

// --- CONSTRUCTION DE LA REQUÃŠTE ---
$where_clause = "";
$params = [];
$types = "";

if (!empty($recherche)) {
    $where_clause = "WHERE (nom LIKE ? OR telephone LIKE ? OR email LIKE ?)";
    $recherche_param = "%$recherche%";
    $params = [$recherche_param, $recherche_param, $recherche_param];
    $types = "sss";
}

// Compte total
$count_query = "SELECT COUNT(*) as total FROM fournisseurs $where_clause";
if (!empty($params)) {
    $stmt = $conn->prepare($count_query);
    $stmt->bind_param($types, ...$params);
    $stmt->execute();
    $count_result = $stmt->get_result();
    $total_rows = (is_object($count_result) && method_exists($count_result, 'fetch_assoc') ? $count_result->fetch_assoc() : mysqli_fetch_assoc($count_result))['total'];
    $stmt->close();
} else {
    $count_result = $conn->query($count_query);
    $total_rows = (is_object($count_result) && method_exists($count_result, 'fetch_assoc') ? $count_result->fetch_assoc() : mysqli_fetch_assoc($count_result))['total'];
}
$total_pages = ceil($total_rows / $per_page);

// RequÃªte principale
$query = "SELECT f.*, COUNT(DISTINCT a.id) as nb_commandes, COALESCE(SUM(a.montant_total), 0) as total_commandes 
          FROM fournisseurs f 
          LEFT JOIN achats a ON f.id = a.id_fournisseur 
          $where_clause 
          GROUP BY f.id 
          ORDER BY f.nom ASC 
          LIMIT ? OFFSET ?";
$params[] = $per_page;
$params[] = $offset;
$types .= "ii";

$stmt = $conn->prepare($query);
$stmt->bind_param($types, ...$params);
$stmt->execute();
$result = $stmt->get_result();

// Fournisseur Ã  modifier
$fournisseur_edit = null;
if (isset($_GET['edit']) && $peut_modifier) {
    $id_edit = intval($_GET['edit']);
    $stmt = $conn->prepare("SELECT * FROM fournisseurs WHERE id = ?");
    $stmt->bind_param("i", $id_edit);
    $stmt->execute();
    $result_edit = $stmt->get_result();
    $fournisseur_edit = (is_object($result_edit) && method_exists($result_edit, 'fetch_assoc') ? $result_edit->fetch_assoc() : mysqli_fetch_assoc($result_edit));
    $stmt->close();
}
?>
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ğŸšš Gestion des fournisseurs - Smart Stock</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../../assets/css/styles_connected.css">
</head>
<body>

<header>
    <nav class="navbar">
        <div class="nav-left">
            <a href="index.php" class="logo-link">
                <img src="../../assets/images/logo_epicerie.png" alt="Logo" class="logo-navbar">
            </a>
            <a href="index.php" class="nav-link">Tableau de bord</a>
            <a href="stock.php" class="nav-link">Stock</a>
            <a href="ventes.php" class="nav-link">Ventes</a>
            <a href="clients.php" class="nav-link">Clients</a>
            <a href="fournisseurs.php" class="nav-link">Fournisseurs</a>
            <a href="commandes.php" class="nav-link">Commandes</a>
            <a href="categories.php" class="nav-link">CatÃ©gories</a>
        </div>
        <a href="logout.php" class="logout">ğŸšª DÃ©connexion</a>
    </nav>
</header>

<div class="main-container">
    <div class="content-wrapper">
    <h1>ğŸšš Gestion des fournisseurs</h1>

        <?php if ($message): ?>
            <div class="message <?= strpos($message, 'âœ…') !== false ? 'success' : (strpos($message, 'âš ï¸') !== false ? 'warning' : 'error') ?>">
                <?= $message ?>
            </div>
        <?php endif; ?>

    <!-- Recherche -->
    <div class="filters">
        <form method="GET" style="display: flex; gap: 10px; width: 100%;">
            <input type="text" name="recherche" placeholder="ğŸ” Rechercher un fournisseur..." value="<?= htmlspecialchars($recherche) ?>" style="flex: 1;">
            <button type="submit" class="btn">Filtrer</button>
            <a href="fournisseurs.php" class="btn btn-secondary">RÃ©initialiser</a>
        </form>
    </div>

    <!-- Export -->
    <div class="export-buttons">
        <a href="?export=csv">ğŸ“¥ Exporter en CSV</a>
    </div>

    <?php if ($peut_modifier): ?>
        <h3><?= $fournisseur_edit ? 'âœï¸ Modifier un fournisseur' : 'â• Ajouter un fournisseur' ?></h3>
        <form method="POST">
            <?php if ($fournisseur_edit): ?>
                <input type="hidden" name="id" value="<?= $fournisseur_edit['id'] ?>">
            <?php endif; ?>
            <div class="form-group">
                <label>Nom du fournisseur :</label>
                <input type="text" name="nom" placeholder="Nom du fournisseur" value="<?= $fournisseur_edit ? htmlspecialchars($fournisseur_edit['nom']) : '' ?>" required>
            </div>
            <div class="form-group">
                <label>TÃ©lÃ©phone :</label>
                <input type="text" name="telephone" placeholder="TÃ©lÃ©phone" value="<?= $fournisseur_edit ? htmlspecialchars($fournisseur_edit['telephone']) : '' ?>">
            </div>
            <div class="form-group">
                <label>Email :</label>
                <input type="email" name="email" placeholder="Email" value="<?= $fournisseur_edit ? htmlspecialchars($fournisseur_edit['email']) : '' ?>">
            </div>
            <div class="form-group">
                <label>Adresse :</label>
                <textarea name="adresse" placeholder="Adresse"><?= $fournisseur_edit ? htmlspecialchars($fournisseur_edit['adresse']) : '' ?></textarea>
            </div>
            <button type="submit" name="<?= $fournisseur_edit ? 'modifier' : 'ajouter' ?>" class="btn">
                <?= $fournisseur_edit ? 'âœï¸ Modifier' : 'â• Ajouter' ?>
            </button>
            <?php if ($fournisseur_edit): ?>
                <a href="fournisseurs.php" class="btn btn-secondary">Annuler</a>
            <?php endif; ?>
        </form>
    <?php else: ?>
            <div class="message warning">
                â„¹ï¸ Vous n'avez pas les droits pour ajouter ou supprimer des fournisseurs.<br>
                Seuls les <strong>admins</strong> et <strong>responsables approvisionnement</strong> peuvent le faire.
            </div>
    <?php endif; ?>

        <h3>ğŸ“‹ Liste des fournisseurs (<?= $total_rows ?> fournisseur<?= $total_rows > 1 ? 's' : '' ?>)</h3>
    <table>
            <thead>
        <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>TÃ©lÃ©phone</th>
            <th>Email</th>
            <th>Adresse</th>
                    <th>Commandes</th>
                    <th>Total (â‚¬)</th>
                    <?php if ($peut_modifier): ?><th>Actions</th><?php endif; ?>
        </tr>
            </thead>
            <tbody>
                <?php 
                if ((is_object($result) && method_exists($result, 'num_rows') ? $result->num_rows() : mysqli_num_rows($result)) > 0):
                    while ($row = (is_object($result) && method_exists($result, 'fetch_assoc') ? $result->fetch_assoc() : mysqli_fetch_assoc($result))): 
                ?>
        <tr>
            <td><?= $row['id'] ?></td>
            <td><?= htmlspecialchars($row['nom']) ?></td>
            <td><?= htmlspecialchars($row['telephone']) ?></td>
            <td><?= htmlspecialchars($row['email']) ?></td>
            <td><?= htmlspecialchars($row['adresse']) ?></td>
                    <td><?= $row['nb_commandes'] ?></td>
                    <td style="font-weight: bold; color: var(--primary-color);"><?= number_format($row['total_commandes'], 2, ',', ' ') ?> â‚¬</td>
            <?php if ($peut_modifier): ?>
                        <td>
                            <a href="?edit=<?= $row['id'] ?>&<?= http_build_query(array_merge($_GET, ['edit' => $row['id']])) ?>" class="btn btn-info btn-sm">âœï¸ Modifier</a>
                            <a href="?supprimer=<?= $row['id'] ?>" class="btn btn-danger btn-sm" onclick="return confirm('ÃŠtes-vous sÃ»r ?')">ğŸ—‘ï¸ Supprimer</a>
                        </td>
            <?php endif; ?>
        </tr>
                <?php 
                    endwhile;
                else:
                ?>
                <tr>
                    <td colspan="<?= $peut_modifier ? '8' : '7' ?>" style="text-align: center; padding: 20px;">
                        Aucun fournisseur trouvÃ©.
                    </td>
                </tr>
                <?php endif; ?>
            </tbody>
    </table>

    <!-- Pagination -->
    <?php if ($total_pages > 1): ?>
    <div class="pagination">
        <?php if ($page > 1): ?>
            <a href="?page=<?= $page - 1 ?>&<?= http_build_query(array_merge($_GET, ['page' => $page - 1])) ?>">Â« PrÃ©cÃ©dent</a>
        <?php endif; ?>
        
        <?php for ($i = max(1, $page - 2); $i <= min($total_pages, $page + 2); $i++): ?>
            <?php if ($i == $page): ?>
                <span class="active"><?= $i ?></span>
            <?php else: ?>
                <a href="?page=<?= $i ?>&<?= http_build_query(array_merge($_GET, ['page' => $i])) ?>"><?= $i ?></a>
            <?php endif; ?>
        <?php endfor; ?>
        
        <?php if ($page < $total_pages): ?>
            <a href="?page=<?= $page + 1 ?>&<?= http_build_query(array_merge($_GET, ['page' => $page + 1])) ?>">Suivant Â»</a>
        <?php endif; ?>
    </div>
    <?php endif; ?>
    </div>
</div>

</body>
</html>
